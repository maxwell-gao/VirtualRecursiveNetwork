name: looper@LoopTransformer
loss:
  name: losses@CrossEntropyLossHead
  loss_type: softmax_cross_entropy
  mask_penalty_weight: 0.0  # 论文不使用 mask penalty

halt_exploration_prob: 0.0
halt_max_steps: ${.dis_max_steps}
act_enabled: false
act_inference: false
no_ACT_continue: true

# DIS Configuration (following paper settings)
dis_enabled: true
dis_max_steps: 6         # 论文值: Nsup=6
dis_schedule: linear     # 线性递减 mask 率
dis_loss_method: mask
dis_step_weighting: true

gradient_checkpointing: false  # 论文 T=1 不需要

hidden_size: 512
num_heads: 8
expansion: 4

puzzle_emb_ndim: ${.hidden_size}
puzzle_emb_len: 16

pos_encodings: rope
forward_dtype: bfloat16
dropout: 0.0

# Loop Configuration (paper: T=1, n=2)
# Total forward passes per step: T*(n+1) = 1*3 = 3
# Total with gradients: Nsup * 3 = 6 * 3 = 18
outer_cycles: 1    # 论文 T=1
no_grad_cycles: 0  # DIS 模式所有 cycles 都有梯度

# State Configuration (paper uses single z state)
# Paper n=2 means: 2 updates of z_L, then 1 update of z_H
# Simplified to single z with repeat=2 (internal updates)
states:
  - name: z
    layers: 1

stages:
  - target: z
    include_inputs: true
    repeat: 2  # n=2 internal updates

readout_state: z
halt_state: z
